<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>最寄り避難所ナビ</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <style>
      html, body { height: 100%; margin: 0; }
      #map { width: 100%; height: 80vh; }
      .panel { padding: 8px 12px; }
      .muted { color: #666; font-size: 0.9em; }
      .error { color: #c00; }
    </style>
  </head>
  <body>
    <div class="panel">
      <h2>最寄り避難所ナビ</h2>
      <div id="status" class="muted">現在地を取得しています…</div>
      <div>
        端末の位置情報を許可すると、最寄りの避難所までの最短経路を表示します。
      </div>
    </div>
    <div id="map"></div>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>
    <script>
      const statusEl = document.getElementById('status');
      const map = L.map('map');
      const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      });
      tiles.addTo(map);

      let userMarker = null;
      let shelterMarker = null;
      let routeLayer = null;

      function setStatus(msg, isError=false){
        statusEl.textContent = msg;
        statusEl.className = isError ? 'error' : 'muted';
      }

      async function fetchJSON(url){
        const r = await fetch(url);
        if(!r.ok){
          let body = '';
          try { body = await r.text(); } catch(e){}
          throw new Error(`HTTP ${r.status} ${r.statusText} ${body}`.trim());
        }
        return await r.json();
      }

      function drawRoute(geojson){
        if(routeLayer){
          map.removeLayer(routeLayer);
          routeLayer = null;
        }
        routeLayer = L.geoJSON(geojson, { style: { color: '#0066cc', weight: 5 } });
        routeLayer.addTo(map);
        map.fitBounds(routeLayer.getBounds(), { padding: [30,30] });
      }

      function markUser(lat, lng){
        if(userMarker){ userMarker.setLatLng([lat,lng]); return; }
        userMarker = L.marker([lat, lng], { title: 'あなたの現在地' }).addTo(map);
      }

      function markShelter(s){
        if(shelterMarker){ shelterMarker.setLatLng([s.lat, s.lon]); return; }
        shelterMarker = L.marker([s.lat, s.lon], { title: s.name }).addTo(map);
        shelterMarker.bindPopup(`<b>${s.name}</b><br/>${s.address}`).openPopup();
      }

      function locateAndRoute(){
        if(!navigator.geolocation){
          setStatus('端末が位置情報に対応していません。', true);
          map.setView([35.681236, 139.767125], 12); // 東京駅あたり
          return;
        }

        navigator.geolocation.getCurrentPosition(async (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          markUser(lat, lng);
          map.setView([lat, lng], 15);
          setStatus('最寄りの避難所を検索しています…');

          try {
            const nearest = await fetchJSON(`/api/nearest?lat=${lat}&lng=${lng}`);
            const s = nearest.shelter;
            markShelter(s);

            setStatus('経路を取得しています…');
            const route = await fetchJSON(`/api/route?from_lat=${lat}&from_lng=${lng}&to_lat=${s.lat}&to_lng=${s.lon}&profile=walking`);
            if(route.route && route.route.geometry){
              drawRoute(route.route.geometry);
              const dist = route.route.distance;
              const minutes = route.route.duration ? Math.round(route.route.duration/60) : null;
              let info = `距離: ${(dist/1000).toFixed(2)} km`;
              if(minutes !== null) info += ` / 予想時間: 約${minutes}分`;
              setStatus(`${s.name}（${s.address}）までの経路を表示中。${info}`);
            } else {
              setStatus('経路を取得できませんでした。直線表示に切替えます。');
              const line = {
                type: 'LineString',
                coordinates: [ [lng, lat], [s.lon, s.lat] ]
              };
              drawRoute(line);
            }
          } catch (e) {
            console.error(e);
            // Try to diagnose if shelters are missing
            try {
              const shelters = await fetchJSON('/api/shelters');
              if(!shelters || shelters.length === 0){
                setStatus('避難所CSVが読み込めません（0件）。data/shelters.csv の場所やヘッダ（name/address/lat/lon など）を確認してください。', true);
                return;
              }
            } catch(_) {}
            setStatus('避難所情報または経路取得でエラーが発生しました: ' + (e && e.message ? e.message : e), true);
          }
        }, (err) => {
          console.warn(err);
          setStatus('位置情報の取得が拒否/失敗しました。地図をドラッグで確認してください。', true);
          map.setView([35.681236, 139.767125], 12);
        }, { enableHighAccuracy: true, timeout: 15000 });
      }

      // Initialize
      map.setView([35.681236, 139.767125], 12);
      locateAndRoute();
    </script>
  </body>
  </html>
