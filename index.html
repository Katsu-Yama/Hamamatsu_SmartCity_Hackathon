<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>é¿é›£ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°GO!ï¼ˆARè©¦ä½œãƒ»ä¿®æ­£ç‰ˆ6ï¼šå®‰å…¨ãƒ­ãƒ¼ãƒ‰ï¼†ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¼·åŒ–ï¼‰</title>
  <style>
    :root { color-scheme: light dark; }
    body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    #ui { position: fixed; top: 8px; left: 8px; right: 8px; z-index: 9999; display: grid; gap: 8px; }
    .card { background: rgba(0,0,0,0.55); color: #fff; padding: 10px 12px; border-radius: 12px; backdrop-filter: blur(6px); }
    .row { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .btn { background:#21a366; color:#fff; border:none; padding:8px 12px; border-radius:10px; font-weight:600; cursor:pointer; }
    .btn.secondary { background:#444; }
    .btn.warn { background:#c2352b; }
    .btn.gray { background:#666; }
    .field { display:flex; gap:6px; align-items:center; flex-wrap: wrap; }
    .field input { flex: 1 1 120px; min-width: 80px; padding:6px 8px; border-radius:8px; border:1px solid #666; background:#111; color:#fff; }
    #mapWrap { position: fixed; inset: 0; display:none; background:#000; }
    #map { width:100%; height:100%; }
    #staticMap { width:100%; height:100%; object-fit: contain; display:none; background:#111; }
    .bubble { position: fixed; bottom: 16px; left: 8px; right: 8px; background: rgba(0,0,0,0.65); color:#fff; padding:10px 12px; border-radius:12px; z-index:9999; }
    .chip { display:inline-block; background:#ffbf00; color:#111; padding:2px 8px; border-radius:999px; font-weight:700; margin-right:8px; }
    a { color:#7fd0ff; }
    .diag { position: fixed; top: 8px; right: 8px; z-index: 10000; font-size: 12px; background: rgba(255,255,255,0.9); color:#111; padding: 6px 8px; border-radius: 8px; max-width: 60ch; white-space: pre-wrap; }
    @media (prefers-color-scheme: dark){ .diag{ background: rgba(0,0,0,0.7); color:#fff; } }
  </style>
</head>
<body>
  <div id="diag" class="diag">è¨ºæ–­: åˆæœŸåŒ–ä¸­â€¦</div>

  <div id="ui">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div style="font-weight:700;">ğŸƒâ€â™‚ï¸ é¿é›£ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°GO!ï¼ˆä¿®æ­£ç‰ˆ6ï¼‰</div>
        <div class="row">
          <button class="btn" id="toggleAr">ARé–‹å§‹</button>
          <button class="btn secondary" id="toggleMap">åœ°å›³</button>
        </div>
      </div>
      <div class="row field">
        <span>ç¾åœ¨åœ°ï¼š</span>
        <input id="lat" placeholder="ç·¯åº¦" />
        <input id="lon" placeholder="çµŒåº¦" />
      </div>
      <div class="row field" style="margin-top:4px; font-size:13px;">
        <span>ä½æ‰€ã‹ã‚‰è¨­å®šï¼š</span>
        <input id="addressInput" placeholder="ä¾‹ï¼‰é™å²¡çœŒæµœæ¾å¸‚ä¸­åŒºå…ƒåŸç”º103-2 ãªã©" />
        <button class="btn secondary" id="geocodeBtn" style="white-space:nowrap;">ä½æ‰€â†’ç¾åœ¨åœ°</button>
      </div>
      <div class="row field">
        <span>é¿é›£æ‰€ï¼š</span>
        <input id="shelterName" placeholder="åç§°" value="æµœæ¾å¸‚å½¹æ‰€ï¼ˆä¾‹ï¼‰" />
        <input id="shelterLat" placeholder="ç·¯åº¦" value="34.710" />
        <input id="shelterLon" placeholder="çµŒåº¦" value="137.727" />
      </div>
      <div class="card" style="margin-top:8px;">
        <div style="font-weight:700; margin-bottom:4px;">ğŸ§® ç°¡æ˜“ã€Œåˆ°é”ç¯„å›²ã€ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿</div>
        <div class="row field">
          <span>å¹´é½¢ï¼š</span>
          <input id="ageInput" type="number" min="5" max="110" placeholder="ä¾‹ï¼‰40" style="max-width:90px;" />
          <button class="btn gray" id="ageToSpeedBtn" style="white-space:nowrap;">åšåŠ´çœãƒ‡ãƒ¼ã‚¿ã‹ã‚‰åˆæœŸå€¤</button>
        </div>
        <div class="row field">
          <span>æ­©è¡Œé€Ÿåº¦(æ¨å®š)ï¼š</span>
          <input id="speedInput" type="number" min="0.2" max="3.0" step="0.1" placeholder="m/ç§’" />
          <span style="font-size:12px; opacity:0.85;">â€»ãƒ­ã‚°ã‹ã‚‰è‡ªå‹•è£œæ­£</span>
        </div>
        <div class="row field">
          <span>é¿é›£ã«ä½¿ãˆã‚‹æ™‚é–“ï¼š</span>
          <input id="timeMinutesInput" type="number" min="1" max="180" value="30" style="max-width:90px;" />
          <span>åˆ†</span>
          <button class="btn" id="reachAreaBtn" style="white-space:nowrap;">åˆ°é”ã§ãã‚‹ç¯„å›²ã‚’å††ã§è¡¨ç¤º</button>
        </div>
        <div style="margin-top:4px; font-size:12px; opacity:0.9;">
          â— æ—¥å¸¸ã®é‹å‹•ã‚„é¿é›£ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®ãƒ­ã‚°ã‹ã‚‰ã€ã‚ãªãŸå€‹äººã®ç§»å‹•èƒ½åŠ›ã«è¿‘ã¥ã‘ã¾ã™ï¼ˆç«¯æœ«å†…ã®ã¿ä¿å­˜ï¼‰ã€‚
        </div>
        <div class="row field" style="margin-top:4px; font-size:12px;">
          <span>ä»Šå›ã®ãƒ­ã‚°ï¼š</span>
          <input id="logDistanceInput" type="number" min="10" step="10" placeholder="ç§»å‹•è·é›¢ m" style="max-width:110px;" />
          <input id="logTimeInput" type="number" min="0.5" step="0.5" placeholder="æ‰€è¦æ™‚é–“ åˆ†" style="max-width:110px;" />
          <button class="btn secondary" id="addLogBtn" style="white-space:nowrap;">ãƒ­ã‚°ã¨ã—ã¦è¨˜éŒ²</button>
        </div>
        <div id="logSummary" style="margin-top:4px; font-size:12px; opacity:0.9;">
          ãƒ­ã‚°ï¼šã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
        </div>
      </div>
      <div class="row field">
        <span>ORS API Keyï¼š</span>
        <input id="orsKey" placeholder="OpenRouteService APIã‚­ãƒ¼" />
        <button class="btn" id="planBtn">çµŒè·¯ä½œæˆï¼ˆORSï¼‰</button>
        <button class="btn warn" id="planOsrmBtn" title="ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—">çµŒè·¯ä½œæˆï¼ˆOSRMæ­©è¡Œ/äºˆå‚™ï¼‰</button>
        <button class="btn secondary" id="demoBtn" title="ãƒãƒƒãƒˆä¸è¦ã®æç”»ãƒ†ã‚¹ãƒˆ">ãƒ‡ãƒ¢çµŒè·¯</button>
      </div>
      <div class="row" style="align-items:center; gap:8px;">
        <div id="status" style="font-size:14px; opacity:0.9;">ğŸ“¡ ä½ç½®å–å¾—å¾…æ©Ÿä¸­â€¦</div>
        <button class="btn gray" id="manualBtn" title="ä½ç½®å–å¾—ã‚’å¾…ãŸãšã«æ‰‹å…¥åŠ›ã‚’ä½¿ã†">æ‰‹å…¥åŠ›ã§é–‹å§‹</button>
        <button class="btn secondary" id="mapOnlyBtn" title="ARã‚’ä½¿ã‚ãšåœ°å›³ã®ã¿ã§ä½¿ã†ï¼ˆæ¨å¥¨ï¼‰">åœ°å›³ã®ã¿ã§ä½¿ã†</button>
      </div>
      <div id="inappWarn" style="display:none; margin-top:8px; font-size:12px; opacity:0.9;">
        âš ï¸ ãƒ¡ãƒ¼ãƒ«å†…/ã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ã‚«ãƒ¡ãƒ©ãƒ»ã‚»ãƒ³ã‚µãƒ¼ãƒ»å¤–éƒ¨CDNãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚Safari/Chromeã§**GitHub Pagesã®HTTPS URL**ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚
      </div>
    </div>
  </div>

  <div class="bubble" id="bubble">ğŸ‘‹ <span id="charName">å®¶åº·ãã‚“</span>ï¼šå®‰å…¨ã«æ°—ã‚’ã¤ã‘ã¦é€²ã‚‚ã†ï¼</div>

  <!-- ARã¯å¾Œã‹ã‚‰å‹•çš„ç”Ÿæˆï¼ˆå¤–éƒ¨CDNã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚‚é…å»¶ãƒ­ãƒ¼ãƒ‰ï¼‰ -->
  <div id="arContainer"></div>

  <!-- åœ°å›³ï¼ˆLeaflet ã‹ é™çš„ãƒãƒƒãƒ—ï¼‰ -->
  <div id="mapWrap"><div id="map"></div><img id="staticMap" alt="Static Map (fallback)" /></div>

  <script>
    // ====== ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨ºæ–­ & ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ© ======
    const diag = document.getElementById('diag');
    const logDiag = (m) => diag.textContent = `è¨ºæ–­: ${m}`;
    window.addEventListener('error', (ev)=>{
      logDiag(`ã‚¨ãƒ©ãƒ¼: ${ev.message || 'ä¸æ˜'} @${ev.filename || 'n/a'}:${ev.lineno || 0}`);
      const st = document.getElementById('status');
      if (st) st.textContent = 'âš ï¸ ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¨ãƒ©ãƒ¼ã€‚å¤–éƒ¨ãƒ–ãƒ©ã‚¦ã‚¶/HTTPS/ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
    });

    // ====== ç’°å¢ƒåˆ¤å®š ======
    const isSecure = location.protocol === 'https:' || location.hostname === 'localhost';
    const ua = navigator.userAgent || '';
    const isInApp = /(Line|FBAN|FBAV|Instagram|GSA|Gmail|Twitter|wv|WebView)/i.test(ua);
    if (!isSecure) logDiag('éHTTPSç’°å¢ƒã§ã™ã€‚ä½ç½®æƒ…å ±/ã‚«ãƒ¡ãƒ©ã¯å‹•ä½œã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
    if (isInApp) document.getElementById('inappWarn').style.display = 'block';

    // ====== å‚ç…§è¦ç´  ======
    const latEl = document.getElementById('lat');
    const lonEl = document.getElementById('lon');
    const orsKeyEl = document.getElementById('orsKey');
    const planBtn = document.getElementById('planBtn');
    const planOsrmBtn = document.getElementById('planOsrmBtn');
    const demoBtn = document.getElementById('demoBtn');
    const manualBtn = document.getElementById('manualBtn');
    const mapOnlyBtn = document.getElementById('mapOnlyBtn');
    const statusEl = document.getElementById('status');
    const bubbleEl = document.getElementById('bubble');
    const charNameEl = document.getElementById('charName');
    const toggleArBtn = document.getElementById('toggleAr');
    const toggleMapBtn = document.getElementById('toggleMap');
    const mapWrap = document.getElementById('mapWrap');
    const mapDiv = document.getElementById('map');
    const staticMapImg = document.getElementById('staticMap');
    const arContainer = document.getElementById('arContainer');
    // ç°¡æ˜“ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿é–¢é€£
    const addressInputEl = document.getElementById('addressInput');
    const geocodeBtn = document.getElementById('geocodeBtn');
    const ageInputEl = document.getElementById('ageInput');
    const ageToSpeedBtn = document.getElementById('ageToSpeedBtn');
    const speedInputEl = document.getElementById('speedInput');
    const timeMinutesInputEl = document.getElementById('timeMinutesInput');
    const reachAreaBtn = document.getElementById('reachAreaBtn');
    const logDistanceInputEl = document.getElementById('logDistanceInput');
    const logTimeInputEl = document.getElementById('logTimeInput');
    const addLogBtn = document.getElementById('addLogBtn');
    const logSummaryEl = document.getElementById('logSummary');

    let map, routeLayer, markersLayer, reachCircleLayer;
    let shelters = [];
    let sheltersLoaded = false;
    let routeCoords = [];
    let manualMode = false;
    const wpEveryMeters = 100; // 100m
    let arReady = false;
    const LOG_STORAGE_KEY = 'evac_sim_walk_logs_v1';

    // ====== ä½ç½®æƒ…å ±ï¼ˆç„¡å¿œç­”å¯¾ç­–ä»˜ãï¼‰ ======
    let geoResponded = false;
    setTimeout(()=>{ if (!geoResponded && !manualMode) { manualMode = true; statusEl.textContent = 'ğŸ–Šï¸ æ‰‹å…¥åŠ›ã®ç¾åœ¨åœ°ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼ˆä½ç½®å–å¾—ã‚¹ã‚­ãƒƒãƒ—ï¼‰'; } }, 3000);
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition((pos) => {
        if (manualMode) return; geoResponded = true;
        latEl.value = pos.coords.latitude.toFixed(6);
        lonEl.value = pos.coords.longitude.toFixed(6);
        statusEl.innerText = `ğŸ“ ç¾åœ¨åœ°: ${latEl.value}, ${lonEl.value}`;
      }, (err) => { geoResponded = true; if (!manualMode) statusEl.innerText = `âš ï¸ ä½ç½®å–å¾—å¤±æ•—: ${err.message}`; }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 10000 });
      navigator.geolocation.watchPosition((pos) => {
        if (!manualMode) {
          const nearest = nearestWaypoint(pos.coords.latitude, pos.coords.longitude);
          if (nearest) {
            const { name, dist } = nearest; charNameEl.textContent = name;
            bubbleEl.innerHTML = `ğŸ‘‹ <span class="chip">${name}</span> æ®‹ã‚Š ${Math.round(dist)}mã€‚äº¤å·®ç‚¹ã§ã¯å‘¨å›²ã‚’ç¢ºèªï¼`;
          }
        }
      });
    }
    function onManualInput(){ const la=parseFloat(latEl.value), lo=parseFloat(lonEl.value); if(isValidLatLon(la,lo)){ manualMode=true; statusEl.innerText = `ğŸ–Šï¸ æ‰‹å…¥åŠ›ã®ç¾åœ¨åœ°ã‚’ä½¿ç”¨ä¸­: ${la.toFixed(6)}, ${lo.toFixed(6)}`; } }
    latEl.addEventListener('input', onManualInput); lonEl.addEventListener('input', onManualInput);

    // ====== ç°¡æ˜“ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ï¼šåˆæœŸåŒ– ======
    initWalkLogsFromStorage();
    if (!speedInputEl.value) {
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 1.0 m/sï¼ˆé«˜é½¢è€…ã‚‚æƒ³å®šã—ãŸæ§ãˆã‚å€¤ï¼‰
      speedInputEl.value = '1.0';
    }

    // ====== UIæ“ä½œ ======
    mapOnlyBtn.addEventListener('click', showMapOnly);
    manualBtn.addEventListener('click', ()=>{ manualMode = true; const la = parseFloat(latEl.value)||34.705; const lo = parseFloat(lonEl.value)||137.730; statusEl.textContent = `ğŸ–Šï¸ æ‰‹å…¥åŠ›ã®ç¾åœ¨åœ°ã‚’ä½¿ç”¨ä¸­: ${la.toFixed(6)}, ${lo.toFixed(6)}`; });
    toggleMapBtn.addEventListener('click', showMapOnly);
    toggleArBtn.addEventListener('click', startAR);

    // ä½æ‰€â†’ç¾åœ¨åœ°
    geocodeBtn.addEventListener('click', async () => {
      const addr = (addressInputEl.value || '').trim();
      if (!addr) { alert('ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
      try {
        statusEl.textContent = 'ğŸ” ä½æ‰€ã‹ã‚‰ä½ç½®ã‚’æ¤œç´¢ä¸­â€¦';
        const { lat, lon } = await geocodeAddress(addr);
        latEl.value = lat.toFixed(6);
        lonEl.value = lon.toFixed(6);
        manualMode = true;
        statusEl.textContent = `ğŸ“ ä½æ‰€ã‹ã‚‰ç¾åœ¨åœ°ã‚’è¨­å®š: ${latEl.value}, ${lonEl.value}`;
        showMapOnly();
        // åœ°å›³ãŒã‚ã‚Œã°ä¸­å¿ƒç§»å‹•
        if (await ensureLeaflet()) {
          if (!map) {
            map = L.map('map');
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
            routeLayer = L.polyline([], {color:'green', weight:5}).addTo(map);
            markersLayer = L.layerGroup().addTo(map);
          }
          map.setView([lat, lon], 15);
          markersLayer.clearLayers();
          L.marker([lat, lon]).addTo(markersLayer).bindPopup('ç¾åœ¨åœ°ï¼ˆä½æ‰€ã‹ã‚‰è¨­å®šï¼‰').openPopup();
        }
      } catch (e) {
        alert('ä½æ‰€ã‹ã‚‰ä½ç½®ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚å…¥åŠ›å†…å®¹ã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
        statusEl.textContent = 'âš ï¸ ä½æ‰€æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
        logDiag('geocode error: ' + (e.message || e));
      }
    });

    // å¹´é½¢â†’æ­©è¡Œé€Ÿåº¦åˆæœŸå€¤
    ageToSpeedBtn.addEventListener('click', () => {
      const age = parseFloat(ageInputEl.value);
      if (!isFinite(age)) { alert('å¹´é½¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
      const base = estimateSpeedFromAge(age);
      speedInputEl.value = base.toFixed(1);
      statusEl.textContent = `ğŸƒâ€â™€ï¸ å¹´é½¢ã‹ã‚‰æ¨å®šã—ãŸå¹³å‡æ­©è¡Œé€Ÿåº¦ã‚’è¨­å®šã—ã¾ã—ãŸï¼ˆç´„ ${base.toFixed(1)} m/ç§’ï¼‰`;
      // ãƒ­ã‚°ãŒã‚ã‚Œã°ã€è‡ªå‹•ã§å€‹äººè£œæ­£
      applyLogsToSpeed();
    });

    // åˆ°é”ç¯„å›²å††ã®æç”»
    reachAreaBtn.addEventListener('click', async () => {
      const lat = parseFloat(latEl.value);
      const lon = parseFloat(lonEl.value);
      if (!isValidLatLon(lat, lon)) {
        alert('ç¾åœ¨åœ°ï¼ˆç·¯åº¦ãƒ»çµŒåº¦ï¼‰ã‚’å…ˆã«è¨­å®šã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      const v = parseFloat(speedInputEl.value);
      const tMin = parseFloat(timeMinutesInputEl.value);
      if (!isFinite(v) || v <= 0) { alert('æ­©è¡Œé€Ÿåº¦(m/ç§’)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
      if (!isFinite(tMin) || tMin <= 0) { alert('é¿é›£ã«ä½¿ãˆã‚‹æ™‚é–“(åˆ†)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
      const radius = v * tMin * 60; // m

      statusEl.textContent = `ğŸ§® åˆ°é”ç¯„å›²ã‚’è¨ˆç®—ä¸­â€¦ï¼ˆåŠå¾„ ç´„ ${(radius/1000).toFixed(2)} kmï¼‰`;
      showMapOnly();
      // é¿é›£æ‰€ãƒªã‚¹ãƒˆã‚’äº‹å‰ãƒ­ãƒ¼ãƒ‰
      await ensureSheltersLoaded();
      if (!(await ensureLeaflet())) {
        // LeafletãŒä½¿ãˆãªã„å ´åˆã¯é™çš„ãƒãƒƒãƒ—ã§è¿‘ä¼¼
        const center = {lat, lon};
        const url = `https://staticmap.openstreetmap.de/staticmap.php?center=${center.lat},${center.lon}&zoom=14&size=800x600&markers=${center.lat},${center.lon},lightblue1`;
        staticMapImg.src = url;
        staticMapImg.style.display='block';
        mapDiv.style.display='none';
        logDiag('Leafletæœªåˆ©ç”¨ï¼šåˆ°é”ç¯„å›²ã¯æ¦‚å¿µçš„ãªé™çš„ãƒãƒƒãƒ—è¡¨ç¤ºã®ã¿');
        return;
      }

      if (!map) {
        map = L.map('map');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
        routeLayer = L.polyline([], {color:'green', weight:5}).addTo(map);
        markersLayer = L.layerGroup().addTo(map);
      }
      markersLayer.clearLayers();
      if (reachCircleLayer) {
        reachCircleLayer.remove();
      }
      L.marker([lat, lon]).addTo(markersLayer).bindPopup('ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹').openPopup();
      reachCircleLayer = L.circle([lat, lon], {
        radius,
        color: '#ffa500',
        weight: 2,
        fillColor: '#ffa500',
        fillOpacity: 0.15
      }).addTo(map);
      // åˆ°é”å¯èƒ½ãªé¿é›£æ‰€ã‚’æŠ½å‡º
      const reachable = findReachableShelters({lat, lon}, radius);
      let bestText = 'å††ã®ä¸­ã«ç™»éŒ²ã•ã‚ŒãŸé¿é›£æ‰€ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
      if (reachable.length) {
        // æ¨™é«˜ãŒæœ€ã‚‚é«˜ã„ã‚‚ã®ã‚’ã€Œæ­£è§£ã€ã¨ã™ã‚‹
        reachable.sort((a,b)=>b.elev - a.elev);
        const best = reachable[0];
        bestText = `ã“ã®æ¡ä»¶ãªã‚‰ã€Œ${best.name}ã€ãŒæœ€ã‚‚é«˜ã„é¿é›£å…ˆã§ã™ï¼ˆæ¨™é«˜ ${best.elev.toFixed(1)} m / è·é›¢ ç´„ ${(best.dist/1000).toFixed(2)} kmï¼‰ã€‚`;
        // ãƒãƒ¼ã‚«ãƒ¼æç”»
        reachable.forEach((s,i)=>{
          const isBest = (i===0);
          const marker = L.marker([s.lat, s.lon], { title: s.name });
          marker.addTo(markersLayer).bindPopup(
            `${isBest ? 'â­ æœ€å„ªå…ˆå€™è£œï¼š' : ''}${s.name}<br>` +
            `æ¨™é«˜ï¼š${s.elev.toFixed(1)} m<br>` +
            `è·é›¢ï¼šç´„ ${(s.dist/1000).toFixed(2)} km`
          );
          if (isBest) {
            marker.openPopup();
          }
        });
      }

      map.fitBounds(reachCircleLayer.getBounds(), { padding:[40,40] });
      statusEl.textContent = `âœ… åŠå¾„ ç´„ ${(radius/1000).toFixed(2)} km ã®ç¯„å›²ã‚’è¡¨ç¤ºã—ã¾ã—ãŸï¼ˆå¾’æ­© ${tMin} åˆ†ãƒ»é€Ÿåº¦ ${v.toFixed(1)} m/ç§’ æƒ³å®šï¼‰ã€‚${bestText}`;
    });

    // ãƒ­ã‚°è¿½åŠ 
    addLogBtn.addEventListener('click', () => {
      const dist = parseFloat(logDistanceInputEl.value);
      const tMin = parseFloat(logTimeInputEl.value);
      if (!isFinite(dist) || dist <= 0 || !isFinite(tMin) || tMin <= 0) {
        alert('ç§»å‹•è·é›¢(m)ã¨æ‰€è¦æ™‚é–“(åˆ†)ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      const v = dist / (tMin * 60); // m/s
      appendWalkLog({ distance_m: dist, time_min: tMin, speed_ms: v, ts: Date.now() });
      logDistanceInputEl.value = '';
      logTimeInputEl.value = '';
      statusEl.textContent = `ğŸ“˜ ãƒ­ã‚°ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆä»Šå›ã®å¹³å‡é€Ÿåº¦ ç´„ ${v.toFixed(2)} m/ç§’ï¼‰`;
      applyLogsToSpeed();
    });

    // iOSå‘ã‘ï¼šãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯
    async function requestIOSMotion(){
      try {
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function'){
          const res = await DeviceOrientationEvent.requestPermission();
          logDiag('DeviceOrientation permission: ' + res);
        }
      } catch(e){ logDiag('DeviceOrientation request error: ' + (e.message||e)); }
    }

    function showMapOnly(){ mapWrap.style.display = 'block'; arContainer.innerHTML = ''; }

    async function startAR(){
      if (!isSecure) { alert('HTTPSã§é–‹ã„ã¦ãã ã•ã„ã€‚'); return; }
      if (isInApp) { alert('ã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯å‹•ä½œã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚Safari/Chromeã§é–‹ã„ã¦ãã ã•ã„ã€‚'); }

      // äº‹å‰ã«ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³è¨±å¯ï¼ˆiOSï¼‰ã¨ã‚«ãƒ¡ãƒ©å¯å¦ã®è»½ã„ãƒã‚§ãƒƒã‚¯
      await requestIOSMotion();
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚«ãƒ¡ãƒ©APIã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚æœ€æ–°ç‰ˆã®Safari/Chromeã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
        return;
      }
      try {
        const tmp = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
        tmp.getTracks().forEach(t=>t.stop());
      } catch(e){
        alert('ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚è¨­å®šã‹ã‚‰è¨±å¯ã—ã¦ãã ã•ã„ã€‚(' + (e.name||'') + ')');
        logDiag('getUserMedia error: ' + (e.name||e.message||e));
        return;
      }

      if (!arReady) {
        const ok = await loadARLibs();
        if (!ok) { alert('ARç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚åœ°å›³ã®ã¿ã§ã”åˆ©ç”¨ãã ã•ã„ã€‚'); return; }
        try {
          createARScene();
          arReady = true;
        } catch(e){
          logDiag('createARScene error: ' + (e.message||e));
          alert('ARåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚åœ°å›³ã®ã¿ã§ã”åˆ©ç”¨ãã ã•ã„ã€‚');
          return;
        }
      }
      mapWrap.style.display = 'none';
    }

    // ====== ãƒ©ã‚¤ãƒ–ãƒ©ãƒªé…å»¶ãƒ­ãƒ¼ãƒ‰ ======
    function loadScript(src){
      return new Promise((resolve)=>{ const s=document.createElement('script'); s.src=src; s.async=true; s.crossOrigin='anonymous'; s.onload=()=>resolve(true); s.onerror=()=>resolve(false); document.head.appendChild(s); });
    }
    function loadCss(href){ const l=document.createElement('link'); l.rel='stylesheet'; l.href=href; document.head.appendChild(l); }

    async function loadARLibs(){
      // A-Frame â†’ AR.js â†’ look-at ã®é †
      const ok1 = await loadScript('https://aframe.io/releases/1.2.0/aframe.min.js');
      if (!ok1 || !window.AFRAME) { logDiag('A-Frame èª­è¾¼å¤±æ•—'); return false; }
      const ok2 = await loadScript('https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js');
      if (!ok2) { logDiag('AR.js èª­è¾¼å¤±æ•—'); return false; }
      const ok3 = await loadScript('https://cdn.jsdelivr.net/npm/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js');
      if (!ok3) { logDiag('look-at èª­è¾¼å¤±æ•—'); return false; }
      // rotation-reader ã®æœ€ä½é™ç™»éŒ²
      AFRAME.registerComponent('rotation-reader', { tick: function(){ const _ = this.el && this.el.object3D && this.el.object3D.rotation; } });
      logDiag('ARãƒ©ã‚¤ãƒ–ãƒ©ãƒªOK');
      return true;
    }

    async function ensureLeaflet(){
      if (window.L) return true;
      loadCss('https://unpkg.com/leaflet@1.9.4/dist/leaflet.css');
      let ok = await loadScript('https://unpkg.com/leaflet@1.9.4/dist/leaflet.js');
      if (!ok || !window.L){
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯CDN
        loadCss('https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css');
        ok = await loadScript('https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js');
      }
      return !!window.L;
    }

    function createARScene(){
      arContainer.innerHTML = '';
      const scene = document.createElement('a-scene');
      scene.setAttribute('embedded','');
      scene.setAttribute('vr-mode-ui','enabled: false');
      scene.setAttribute('renderer','antialias: true; alpha: true');
      scene.setAttribute('arjs','sourceType: camera; facingMode: environment; videoTexture: true; debugUIEnabled: false;');
      const cam = document.createElement('a-camera');
      cam.setAttribute('gps-camera','');
      cam.setAttribute('rotation-reader','');
      const wps = document.createElement('a-entity'); wps.id = 'waypoints';
      scene.appendChild(cam); scene.appendChild(wps);
      arContainer.appendChild(scene);
    }

    // ====== çµŒè·¯ä½œæˆãƒãƒ³ãƒ‰ãƒ© ======
    planBtn.addEventListener('click', async () => {
      const key = orsKeyEl.value.trim();
      const lat = parseFloat(latEl.value), lon = parseFloat(lonEl.value);
      const shelLat = parseFloat(document.getElementById('shelterLat').value);
      const shelLon = parseFloat(document.getElementById('shelterLon').value);
      const shelterName = document.getElementById('shelterName').value.trim();
      if (!key || !isValidLatLon(lat,lon) || !isValidLatLon(shelLat,shelLon)) { alert('å…¥åŠ›ï¼ˆAPIã‚­ãƒ¼ï¼åº§æ¨™ï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'); return; }
      manualMode = true; statusEl.innerText = 'ğŸ§­ ORS ã§å¾’æ­©ãƒ«ãƒ¼ãƒˆä½œæˆä¸­â€¦';
      try {
        const resp = await planWithORS({key, start:{lat,lon}, goal:{lat:shelLat,lon:shelLon}});
        if (!resp.ok) throw new Error(resp.msg || 'ORS ã‚¨ãƒ©ãƒ¼');
        applyRoute(resp.coords, shelterName);
        statusEl.innerText = `âœ… ORS ãƒ«ãƒ¼ãƒˆå–å¾—: ${(resp.distance_km).toFixed(2)} km`;
      } catch (e) {
        statusEl.innerText = 'âš ï¸ ORS å¤±æ•—ã€‚OSRM(äºˆå‚™)ã‚‚è©¦ã›ã¾ã™ã€‚';
        logDiag('ORS å–å¾—ã‚¨ãƒ©ãƒ¼è©³ç´°: ' + (e.message || e.toString()));
      }
    });

    planOsrmBtn.addEventListener('click', async () => {
      const lat = parseFloat(latEl.value), lon = parseFloat(lonEl.value);
      const shelLat = parseFloat(document.getElementById('shelterLat').value);
      const shelLon = parseFloat(document.getElementById('shelterLon').value);
      const shelterName = document.getElementById('shelterName').value.trim();
      if (!isValidLatLon(lat,lon) || !isValidLatLon(shelLat,shelLon)) { alert('åº§æ¨™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'); return; }
      manualMode = true; statusEl.innerText = 'ğŸ§­ OSRM(æ­©è¡Œ) ã§ãƒ«ãƒ¼ãƒˆä½œæˆä¸­â€¦';
      try {
        const resp = await planWithOSRM({start:{lat,lon}, goal:{lat:shelLat,lon:shelLon}});
        if (!resp.ok) throw new Error(resp.msg || 'OSRM ã‚¨ãƒ©ãƒ¼');
        applyRoute(resp.coords, shelterName);
        statusEl.innerText = `âœ… OSRM ãƒ«ãƒ¼ãƒˆå–å¾—: ${(resp.distance_km).toFixed(2)} km`;
      } catch (e) {
        statusEl.innerText = 'âš ï¸ OSRM ã‚‚å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
        logDiag('OSRM å–å¾—ã‚¨ãƒ©ãƒ¼è©³ç´°: ' + (e.message || e.toString()));
      }
    });

    demoBtn.addEventListener('click', () => {
      const la = parseFloat(latEl.value); const lo = parseFloat(lonEl.value);
      const lat = isValidLatLon(la,lo) ? la : 34.707; const lon = isValidLatLon(la,lo) ? lo : 137.734;
      manualMode = true; const goal = {lat: lat + 0.004, lon: lon - 0.006}; const demo = [ {lat,lon}, {lat: lat+0.002, lon: lon-0.003}, goal ];
      applyRoute(demo, 'ãƒ‡ãƒ¢é¿é›£æ‰€'); statusEl.innerText = 'âœ… ãƒ‡ãƒ¢çµŒè·¯ã‚’æç”»ã—ã¾ã—ãŸï¼ˆAPIä¸è¦ï¼‰';
    });

    // ====== ORS/OSRM ======
    async function planWithORS({key,start,goal}){
      try {
        const base = 'https://api.openrouteservice.org/v2/directions/foot-walking';
        const url  = `${base}?format=geojson&instructions=false&api_key=${encodeURIComponent(key)}`;
        const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ coordinates: [[start.lon, start.lat], [goal.lon, goal.lat]] }) });
        const text = await res.text(); let json = {}; try { json = JSON.parse(text); } catch(_){ }
        if (!res.ok) { const msg = json && json.error && json.error.message ? json.error.message : `HTTP ${res.status} ${res.statusText}`; return { ok:false, msg: msg + ' / body: ' + text.slice(0,200) }; }
        if (json.features && json.features[0]) {
          const feat = json.features[0]; const coords = feat.geometry.coordinates.map(([x,y])=>({lat:y, lon:x}));
          const dist_km = (feat.properties && feat.properties.summary && feat.properties.summary.distance) ? feat.properties.summary.distance/1000 : NaN;
          return { ok:true, coords, distance_km: dist_km, via:'geojson' };
        }
        if (json.routes && json.routes[0]) {
          const r = json.routes[0];
          if (r.geometry && r.geometry.type === 'LineString' && Array.isArray(r.geometry.coordinates)) {
            const coords = r.geometry.coordinates.map(([x,y])=>({lat:y, lon:x}));
            const dist_km = r.summary && isFinite(r.summary.distance) ? r.summary.distance/1000 : (r.distance? r.distance/1000 : NaN);
            return { ok:true, coords, distance_km: dist_km, via:'routes-geojson' };
          }
          if (r.geometry && typeof r.geometry === 'string') {
            const decoded = decodePolyline(r.geometry);
            if (decoded && decoded.length) {
              const dist_km = r.summary && isFinite(r.summary.distance) ? r.summary.distance/1000 : (r.distance? r.distance/1000 : NaN);
              return { ok:true, coords: decoded, distance_km: dist_km, via:'routes-encoded' };
            }
          }
        }
        return { ok:false, msg: 'ORS å¿œç­”ãŒä¸å®Œå…¨ã§ã™ / body: ' + text.slice(0,200) };
      } catch(e){ return { ok:false, msg: e.message || String(e) }; }
    }

    async function planWithOSRM({start,goal}){
      try {
        const base = 'https://router.project-osrm.org/route/v1/foot/'; const url = `${base}${start.lon},${start.lat};${goal.lon},${goal.lat}?overview=full&geometries=geojson`;
        const res = await fetch(url); const text = await res.text(); let json = {}; try { json = JSON.parse(text); } catch(_){ }
        if (!res.ok || json.code !== 'Ok' || !json.routes || !json.routes[0]) { return { ok:false, msg: `OSRM å¿œç­”ä¸æ­£ / code=${json.code} / body: ${text.slice(0,200)}` }; }
        const route = json.routes[0]; const coords = route.geometry.coordinates.map(([x,y])=>({lat:y, lon:x}));
        return { ok:true, coords, distance_km: route.distance/1000 };
      } catch(e){ return { ok:false, msg: e.message || String(e) }; }
    }

    // ====== åœ°å›³ï¼ˆLeaflet or Staticï¼‰ ======
    async function applyRoute(coords, shelterName){
      routeCoords = coords;
      // 1) åœ°å›³ã¯å¿…ãšå‰é¢è¡¨ç¤º
      if (!(await ensureLeaflet())) {
        renderStaticMap(coords, shelterName);
      } else {
        renderLeafletMap(coords, shelterName);
      }
      // 2) ARãƒã‚¤ãƒ³ãƒˆï¼ˆARé–‹å§‹å¾Œã®ã¿è¡¨ç¤ºï¼‰
      placeWaypoints(coords, shelterName);
    }

    function renderStaticMap(coords, shelterName){
      mapWrap.style.display = 'block';
      const start = coords[0], goal = coords[coords.length-1];
      const center = start;
      const url = `https://staticmap.openstreetmap.de/staticmap.php?center=${center.lat},${center.lon}&zoom=15&size=800x600&markers=${start.lat},${start.lon},lightblue1|${goal.lat},${goal.lon},red`;
      staticMapImg.src = url; staticMapImg.style.display='block'; mapDiv.style.display='none';
      logDiag('Leafletæœªåˆ©ç”¨ï¼šé™çš„ãƒãƒƒãƒ—ã‚’è¡¨ç¤ºï¼ˆCDNãƒ–ãƒ­ãƒƒã‚¯ã®å¯èƒ½æ€§ï¼‰');
    }

    function renderLeafletMap(coords, shelter){
      mapWrap.style.display = 'block';
      staticMapImg.style.display='none'; mapDiv.style.display='block';
      if(!map){
        map = L.map('map');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
        routeLayer = L.polyline([], {color:'green', weight:5}).addTo(map);
        markersLayer = L.layerGroup().addTo(map);
      }
      const latlngs = coords.map(p=>[p.lat, p.lon]);
      routeLayer.setLatLngs(latlngs); markersLayer.clearLayers();
      L.marker(latlngs[0], {title:'å‡ºç™º'}).addTo(markersLayer).bindPopup('å‡ºç™ºåœ°ç‚¹');
      L.marker(latlngs[latlngs.length-1], {title:'é¿é›£æ‰€'}).addTo(markersLayer).bindPopup(`é¿é›£æ‰€ï¼š${shelter}`);
      const sampled = sampleByDistance(coords, wpEveryMeters);
      sampled.forEach((p,i)=>{ const who = i % 2 === 0 ? 'å®¶åº·ãã‚“' : 'ç›´è™ã¡ã‚ƒã‚“'; L.marker([p.lat,p.lon]).addTo(markersLayer).bindPopup(`${who} ãƒã‚¤ãƒ³ãƒˆ`); });
      map.fitBounds(routeLayer.getBounds(), {padding:[40,40]});
    }

    // ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
    function isValidLatLon(lat,lon){ return isFinite(lat) && isFinite(lon) && Math.abs(lat)<=90 && Math.abs(lon)<=180; }
    function toRad(d){ return d*Math.PI/180; }
    function haversine(a,b){ const R=6371000; const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon); const s1=Math.sin(dLat/2), s2=Math.sin(dLon/2); const c=2*Math.asin(Math.sqrt(s1*s1+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2)); return R*c; }
    function sampleByDistance(coords, step){ const out=[coords[0]]; let acc=0; for(let i=1;i<coords.length;i++){ const d=haversine(coords[i-1], coords[i]); acc+=d; if(acc>=step){ out.push(coords[i]); acc=0; } } return out; }
    function nearestWaypoint(lat, lon){ const cam={lat, lon}; const els=[...document.querySelectorAll('#waypoints a-image')]; if(!els || !els.length) return null; let best=null; els.forEach(el=>{ if(!el) return; const attr = el.getAttribute('gps-entity-place'); if(!attr) return; const m = /latitude:\s*([\d\.-]+);\s*longitude:\s*([\d\.-]+)/.exec(attr); if(!m) return; const p={lat: parseFloat(m[1]), lon: parseFloat(m[2])}; const dist = haversine(cam, p); const name = el.getAttribute('title') || 'ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ'; if(!best || dist<best.dist) best={name, dist}; }); return best; }
    function decodePolyline(str, precision=1e-5){ if (!str || typeof str !== 'string') return null; let index = 0, lat = 0, lon = 0, coords = []; const len = str.length; while (index < len) { let b, shift = 0, result = 0; do { b = str.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20); const dlat = ((result & 1) ? ~(result >> 1) : (result >> 1)); lat += dlat; shift = 0; result = 0; do { b = str.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20); const dlon = ((result & 1) ? ~(result >> 1) : (result >> 1)); lon += dlon; coords.push({ lat: lat * precision, lon: lon * precision }); } return coords; }

    // é¿é›£æ‰€ãƒªã‚¹ãƒˆã®ãƒ­ãƒ¼ãƒ‰
    async function ensureSheltersLoaded(){
      if (sheltersLoaded) return;
      try{
        const res = await fetch('é¿é›£æ‰€ãƒªã‚¹ãƒˆ.csv');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        const lines = text.trim().split(/\r?\n/);
        // 1è¡Œç›®ã¯ãƒ˜ãƒƒãƒ€
        shelters = [];
        for (let i=1; i<lines.length; i++){
          const cols = lines[i].split(',');
          if (cols.length < 5) continue;
          const name = cols[0].trim();
          const lat = parseFloat(cols[2]);
          const lon = parseFloat(cols[3]);
          const elev = parseFloat(cols[4]);
          if (!isValidLatLon(lat, lon) || !isFinite(elev)) continue;
          shelters.push({ name, lat, lon, elev });
        }
        sheltersLoaded = true;
        logDiag(`é¿é›£æ‰€ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼š${shelters.length} ä»¶`);
      }catch(e){
        logDiag('é¿é›£æ‰€CSVãƒ­ãƒ¼ãƒ‰å¤±æ•—: ' + (e.message||e));
        sheltersLoaded = true;
      }
    }

    function findReachableShelters(origin, radius){
      if (!shelters || !shelters.length) return [];
      const out = [];
      shelters.forEach(s => {
        const d = haversine(origin, {lat:s.lat, lon:s.lon});
        if (d <= radius){
          out.push({ ...s, dist: d });
        }
      });
      return out;
    }

    // ç°¡æ˜“ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ç”¨ï¼šå¹´é½¢â†’å¹³å‡æ­©è¡Œé€Ÿåº¦ï¼ˆå¹´é½¢å±¤åˆ¥ç§»å‹•èƒ½åŠ›CSVã‚’å…ƒã«ã—ãŸç›®å®‰ï¼‰
    function estimateSpeedFromAge(age){
      // 20-29: 10åˆ†ã§0.9km â†’ 0.9*1000 / 600 â‰’ 1.5 m/s
      // 30-39: 0.87km â†’ â‰’ 1.45 m/s
      // 40-49: 0.84km â†’ â‰’ 1.40 m/s
      // 50-59: 0.81km â†’ â‰’ 1.35 m/s
      // 60-69: 0.78km â†’ â‰’ 1.30 m/s
      // 70-79: 0.72km â†’ â‰’ 1.20 m/s
      // 80+:   0.66km â†’ â‰’ 1.10 m/s
      if (age < 20) return 1.45;      // é«˜æ ¡ç”Ÿã€œè‹¥å¹´
      if (age < 30) return 1.50;
      if (age < 40) return 1.45;
      if (age < 50) return 1.40;
      if (age < 60) return 1.35;
      if (age < 70) return 1.30;
      if (age < 80) return 1.20;
      return 1.10;
    }

    // ä½æ‰€â†’ç·¯åº¦çµŒåº¦ï¼ˆNominatim ã‚’åˆ©ç”¨ï¼‰
    async function geocodeAddress(address){
      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=jp&q=${encodeURIComponent(address)}`;
      const res = await fetch(url, {
        headers: {
          'Accept': 'application/json',
          'User-Agent': 'evac-training-simulator/1.0'
        }
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const arr = await res.json();
      if (!arr || !arr.length) throw new Error('no result');
      return { lat: parseFloat(arr[0].lat), lon: parseFloat(arr[0].lon) };
    }

    // å€‹äººãƒ­ã‚°ã®ä¿å­˜ãƒ»èª­è¾¼
    function initWalkLogsFromStorage(){
      try{
        const raw = localStorage.getItem(LOG_STORAGE_KEY);
        if (!raw) { logSummaryEl.textContent = 'ãƒ­ã‚°ï¼šã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'; return; }
        const logs = JSON.parse(raw);
        updateLogSummary(logs);
      }catch(e){
        logDiag('walk log load error: ' + (e.message||e));
      }
    }

    function appendWalkLog(entry){
      try{
        const raw = localStorage.getItem(LOG_STORAGE_KEY);
        const logs = raw ? JSON.parse(raw) : [];
        logs.push(entry);
        localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(logs));
        updateLogSummary(logs);
      }catch(e){
        logDiag('walk log save error: ' + (e.message||e));
      }
    }

    function updateLogSummary(logs){
      if (!logs || !logs.length){
        logSummaryEl.textContent = 'ãƒ­ã‚°ï¼šã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
        return;
      }
      const n = logs.length;
      let sumSpeed = 0, sumDist = 0, sumTime = 0;
      logs.forEach(l => {
        sumSpeed += l.speed_ms || 0;
        sumDist += l.distance_m || 0;
        sumTime += l.time_min || 0;
      });
      const avgSpeed = sumSpeed / n;
      logSummaryEl.textContent = `ãƒ­ã‚°ä»¶æ•°ï¼š${n} ä»¶ / å¹³å‡é€Ÿåº¦ ç´„ ${avgSpeed.toFixed(2)} m/ç§’ / åˆè¨ˆè·é›¢ ç´„ ${sumDist.toFixed(0)} m`;
    }

    // ãƒ­ã‚°ã®æƒ…å ±ã‚’ç¾åœ¨ã®é€Ÿåº¦å…¥åŠ›ã«åæ˜ ï¼ˆåˆæœŸå€¤ã¨ã®æŠ˜è¡·ï¼‰
    function applyLogsToSpeed(){
      try{
        const raw = localStorage.getItem(LOG_STORAGE_KEY);
        if (!raw) return;
        const logs = JSON.parse(raw);
        if (!logs.length) return;
        let sum = 0;
        logs.forEach(l => { sum += l.speed_ms || 0; });
        const avg = sum / logs.length;
        const cur = parseFloat(speedInputEl.value) || 1.0;
        // ç¾åœ¨å€¤ã¨ãƒ­ã‚°å¹³å‡ã‚’ 50:50 ã§ãƒŸãƒƒã‚¯ã‚¹ã—ã¦ã€æ€¥ãªå¤‰åŒ–ã‚’é¿ã‘ã‚‹
        const mixed = (cur + avg) / 2;
        speedInputEl.value = mixed.toFixed(2);
        updateLogSummary(logs);
      }catch(e){
        logDiag('applyLogsToSpeed error: ' + (e.message||e));
      }
    }

    function placeWaypoints(coords, shelterName){
      const container = document.querySelector('#arContainer #waypoints');
      if (!container || !coords || !coords.length) return;
      container.innerHTML = '';
      const sampled = sampleByDistance(coords, wpEveryMeters); sampled.push(coords[coords.length-1]);
      sampled.forEach((p,i)=>{
        const who = i % 2 === 0 ? {name:'å®¶åº·ãã‚“', img:'https://cdn-icons-png.flaticon.com/512/616/616408.png'} : {name:'ç›´è™ã¡ã‚ƒã‚“', img:'https://cdn-icons-png.flaticon.com/512/616/616430.png'};
        const e = document.createElement('a-image');
        e.setAttribute('src', who.img);
        e.setAttribute('look-at', '[gps-camera]');
        e.setAttribute('gps-entity-place', `latitude: ${p.lat}; longitude: ${p.lon};`);
        e.setAttribute('scale', '8 8 8'); e.setAttribute('opacity', '0.95'); e.setAttribute('title', who.name);
        e.addEventListener('click', () => { charNameEl.textContent = who.name; bubbleEl.innerHTML = `ğŸ‰ <span class="chip">${who.name}</span> ã‚ˆãè¦‹ã¤ã‘ãŸï¼æ¬¡ã®ãƒã‚¤ãƒ³ãƒˆã¸é€²ã‚‚ã†ã€‚`; });
        container.appendChild(e);
      });
      const goal = document.createElement('a-image');
      goal.setAttribute('src', 'https://cdn-icons-png.flaticon.com/512/190/190411.png');
      const last = coords[coords.length-1];
      goal.setAttribute('gps-entity-place', `latitude: ${last.lat}; longitude: ${last.lon};`);
      goal.setAttribute('scale', '10 10 10');
      goal.addEventListener('click', () => { bubbleEl.innerHTML = `âœ… é¿é›£æ‰€ã€Œ${shelterName}ã€ã«åˆ°ç€ï¼ ä»Šæ—¥ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å®Œäº†ã€‚`; });
      container.appendChild(goal);
    }
  </script>

  <div style="position:fixed; bottom:0; right:0; padding:6px 10px; font-size:12px; opacity:0.85; background:#fff; border-top-left-radius:10px;">ğŸš¦ æ­©ãã‚¹ãƒãƒ›ãƒ»é“è·¯æ¨ªæ–­æ™‚ã®ä½¿ç”¨ç¦æ­¢ / ç«‹ã¡æ­¢ã¾ã£ã¦æ“ä½œã—ã¦ãã ã•ã„</div>
</body>
</html>
